name: Frontend CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run tests
        run: yarn test

      - name: Build
        run: yarn build

  deploy:
    name: Deploy to CapRover
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Create captain-definition
        run: |
          cat > captain-definition << 'EOF'
          {
            "schemaVersion": 2,
            "dockerfilePath": "./Dockerfile"
          }
          EOF

      - name: Install CapRover CLI
        run: npm install -g caprover

      - name: Deploy to CapRover
        run: |
          echo "ðŸš€ Deploying frontend to CapRover..."
          tar -czf /tmp/app.tar.gz --exclude=node_modules --exclude=.git .
          caprover deploy \
            --caproverUrl https://captain.infra.plaxo.app \
            --appToken "${{ secrets.CAPROVER_APP_TOKEN_FRONTEND }}" \
            --appName "${{ secrets.CAPROVER_APP_NAME_FRONTEND }}" \
            --tarFile /tmp/app.tar.gz
        env:
          NODE_TLS_REJECT_UNAUTHORIZED: 0
